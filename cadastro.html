<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Configura√ß√µes b√°sicas do HTML -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Varal dos Sonhos</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="./css/style.css">

    <style>
        /* Estilos b√°sicos provis√≥rios - o CSS real deve estar em style.css */
        body { font-family: sans-serif; padding: 20px; }
        form { max-width: 400px; margin: 0 auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        div { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="email"], input[type="password"], select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        #mensagem-status { margin-top: 20px; text-align: center; }
    </style>
 
</head>
<body>
    <!-- Menu de navega√ß√£o -->
    <header>
        <div class="container-header">
          <nav class="nav-menu">
            <ul class="menu-esquerda">
              <li><a href="index.html">In√≠cio</a></li>
              <li><a href="cartinhas.html">Varal Virtual</a></li>
              <li><a href="carrinho.html">Carrinho</a></li>
              <li><a href="pontos.html">Pontos de Coleta</a></li>
            </ul>
            <ul class="menu-direita">
              <li><a href="login.html">Login</a></li>
            </ul>
          </nav>
        </div>
    </header>

    <main>
        <section class="apresentacao">
            <h2>Cadastro</h2>

            <!-- Formul√°rio de cadastro -->
            <form id='cadastroForm' class="formulario" action="login.html" method="POST">
                
                <!-- Escolha do tipo de usu√°rio -->
                <label for="tipo">Eu quero me cadastrar como:</label>
                <select id="tipo" name="tipo" required>
                    <option value="">-- Selecione uma op√ß√£o --</option>
                    <option value="Doador">Doador</option>
                    <option value="PontoColeta">Ponto de Coleta</option>
                    <option value="Comum">Usu√°rio Comum (apenas visualiza√ß√£o)</option>
                </select>

                <!-- Campo nome -->
                <div>
                    <label for="nome">Nome Completo:</label>
                    <input type="text" id="nome" name="nome" required>
                </div>

                <!-- Campo email -->
                <div>
                    <label for="email">E-mail:</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <!-- Campo senha -->
                <div>
                    <label for="senha">Senha:</label>
                    <input type="password" id="senha" name="senha" required>
                </div>

                <!-- Campos extras (endere√ßo e telefone) s√≥ aparecem para Doador/PontoColeta -->
                <div id="campos-perfil">
                    <hr>
                    <h3>Informa√ß√µes de Contato</h3>
                    <div>
                        <label for="endereco">Endere√ßo Completo:</label>
                        <input type="text" id="endereco" name="endereco" required>
                    </div>
                    <div>
                        <label for="telefone">Telefone:</label>
                        <input type="text" id="telefone" name="telefone" required>
                    </div>
                </div>

                <button type="submit" class="btn">Cadastrar</button>
            </form>

            <!-- Mensagem de status exibida ap√≥s tentativa de cadastro -->
            <div id="mensagem-status"></div>
        </section>
    </main>

    <footer>
        <p>¬© 2025 Varal dos Sonhos | Desenvolvido com amor üíô</p>
    </footer>

    <script>
        const form = document.getElementById('cadastroForm');
        const tipo = document.getElementById('tipo');
        const camposPerfil = document.getElementById('campos-perfil');
        const statusDiv = document.getElementById('mensagem-status');

        // (1) L√≥gica: esconde ou mostra campos extras dependendo do tipo de usu√°rio
        tipo.addEventListener('change', function() {
             // Se for Doador ou Ponto de Coleta, mostra os campos de endere√ßo/telefone
            const isProfileType = (this.value === 'Doador' || this.value === 'PontoColeta');
            camposPerfil.style.display = isProfileType ? 'block' : 'none';
            // Define a obrigatoriedade dos campos
            document.getElementById('endereco').required = isProfileType;
            document.getElementById('telefone').required = isProfileType;
        });

        // Chama a fun√ß√£o 'change' na inicializa√ß√£o para esconder por padr√£o
        tipo.dispatchEvent(new Event('change')); // Executa no carregamento inicial

        // (2) L√≥gica: intercepta envio do formul√°rio e envia via fetch para API Vercel
        form.addEventListener('submit', async function(event) {
            event.preventDefault(); // Impede envio normal

             // Coleta todos os dados do formul√°rio
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // CORRE√á√ÉO CR√çTICA: Renomeia 'tipo' (enviado pelo HTML) para 'tipo_usuario' 
            // (esperado pelo Back-end do Vercel)
            // Ajuste: backend espera "tipo_usuario", n√£o "tipo"
            data.tipo_usuario = data.tipo;
            delete data.tipo;

            statusDiv.innerHTML = 'Cadastrando...';
            statusDiv.style.color = '#007bff';

            try {

                // Envia os dados para a sua fun√ß√£o Serverless no Vercel
                const response = await fetch('/api/cadastro', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                const result = await response.json();

                if (response.ok) {
                    statusDiv.innerHTML = '‚úÖ Cadastro realizado com sucesso!';
                    statusDiv.style.color = 'green';
                    form.reset(); // Limpa o formul√°rio

                    // Redireciona o usu√°rio para a p√°gina de login ap√≥s 2 segundos
                    setTimeout(() => { 
                        window.location.href = 'login.html'; }, 2000);
                } else {

                     // Erro retornado pelo Vercel (ex: e-mail j√° existe)
                    statusDiv.innerHTML = `‚ùå Erro: ${result.error || 'Tente novamente.'}`;
                    statusDiv.style.color = 'red';
                }
            } catch (error) {
                statusDiv.innerHTML = '‚ùå Erro de conex√£o com o servidor.';
                statusDiv.style.color = 'red';
            }
        });
    </script>
</body>
</html>
